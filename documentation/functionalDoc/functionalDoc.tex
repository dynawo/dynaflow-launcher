%% Except where otherwise noted, content in this documentation is Copyright (c)
%% 2022, RTE (http://www.rte-france.com) and licensed under a
%% CC-BY-4.0 (https://creativecommons.org/licenses/by/4.0/)
%% license. All rights reserved.

\documentclass[a4paper, 12pt]{report}

% Latex setup
\input{../latex_setup.tex}

\begin{document}

\title{Dynaflow-launcher Functional Documentation}
\date\today

\maketitle
\tableofcontents

\chapter{Functional documentation}

\section[Dynaflow-launcher Overview]{Dynaflow-launcher Overview}
Dynaflow-launcher creates, for a given .iidm network file and config.json, all the input files needed for a DynaFlow simulation, runs a simulation and collects the results.
\par In particular, it generates the .dyd file containing all the modelling choices for all the system's elements and the .par file that contains all the parameters for these models.
\par The next section presents the modelling choices that are made.

\section{Modelling}

The modelling choices are based on two inputs: the configuration file which is defined by the user, and on the network description file (iidm).
The description of the behavior of the models mentionned below can be found in the \Dynawo documentation.

\subsection{Loads}

The models that are used for the loads depend on the parameter \textit{DsoVoltageLevel} in the config file (see section \ref{Dynaflow_Launcher_Configuration_Configuration_File}).
\begin{table}[h!]
\center
\begin{tabular}{ l | c }
\toprule
\textbf{{Voltage condition}} & \textbf{{Model}}\\
\midrule
 $voltage < DsoVoltageLevel$ &  fixed PQ load \\
 $voltage \geq DsoVoltageLevel$ &  DYNModelLoadRestorativeWithLimits \\
\bottomrule
\end{tabular}
\caption{Loads modelling}
\end{table}

\subsection{Generators}

The following parameters from the configuration file are used for generators modelling (see section \ref{Dynaflow_Launcher_Configuration_Configuration_File}):
\begin{itemize}
  \item The parameter \textit{InfiniteReactiveLimits} determines whether the generator models have infinite reactive power limits or PQ diagrams;
  \item The parameter \textit{ActivePowerCompensation} determines whether the generators participate in the active power balancing proportionally to PMax, P or PTarget.
\end{itemize}

The information that a generator partipates or not in the voltage regulation is given in the IIDM input file.

\par Table \ref{tab:generators_modelling} sums up the modelling choices applied by dynaflow-launcher following if a generator is on voltage regulation
or not and where the voltage is controlled. Notice that these modelling associations are different whenever the InfiniteReactiveLimits parameter is set to true
or not and if the reactive capability curve (diagram) of the generator is rectangular (all the values of $Q_{min}$ are equal and all the values of $Q_{max}$ are equal):

\begin{table}[h!]
\center
\begin{tabular}{ c | c | c | c}
\toprule
\scriptsize{\textbf{{Voltage regulation}}} & \scriptsize{\textbf{{InfiniteReactiveLimits}}} & \scriptsize{\textbf{{Rectangular diagram}}} & \scriptsize{\textbf{{Model}}}\\
\midrule
\rowcolor{white}
 \scriptsize{None}  & \scriptsize{-} & \scriptsize{-} & \scriptsize{fixed PQ generator} \\
\rowcolor{gray!10}
 \scriptsize{At the connection bus} & \scriptsize{false} & \scriptsize{false} & \scriptsize{GeneratorPVDiagramPQSignalN} \\
\rowcolor{white}
 \scriptsize{At the connection bus} & \scriptsize{false} & \scriptsize{true} & \scriptsize{GeneratorPVSignalN} \\
\rowcolor{gray!10}
 \scriptsize{At the connection bus} & \scriptsize{true} & \scriptsize{-} & \scriptsize{GeneratorPVSignalN} \\
\rowcolor{white}
 \scriptsize{At a distant bus} & \scriptsize{false} & \scriptsize{false} & \scriptsize{GeneratorPVRemoteDiagramPQSignalN} \\
\rowcolor{gray!10}
 \scriptsize{At a distant bus} & \scriptsize{false} & \scriptsize{true} & \scriptsize{GeneratorPVRemoteSignalN} \\
\rowcolor{white}
 \scriptsize{At a distant bus} & \scriptsize{true} & \scriptsize{-} & \scriptsize{GeneratorPVRemoteSignalN} \\
\rowcolor{gray!10}
\scriptsize{Another generator}&  &  & \scriptsize{GeneratorPQPropDiagramPQSignalN}\\
\rowcolor{gray!10}
\scriptsize{regulates the same node} & \multirow{-2}{*}{\scriptsize{false}} & \multirow{-2}{*}{\scriptsize{false}} & \scriptsize{+ VRRemote model} \\
\rowcolor{white}
\scriptsize{Another generator}&  &  & \scriptsize{GeneratorPQPropSignalN}\\
\rowcolor{white}
\scriptsize{regulates the same node} & \multirow{-2}{*}{\scriptsize{false}} & \multirow{-2}{*}{\scriptsize{true}} & \scriptsize{+ VRRemote model} \\
\rowcolor{gray!10}
\scriptsize{Another generator}&  & & \scriptsize{GeneratorPQPropSignalN}  \\
\rowcolor{gray!10}
\scriptsize{regulates the same node} & \multirow{-2}{*}{\scriptsize{true}} & \multirow{-2}{*}{\scriptsize{-}} & \scriptsize{+ VRRemote model} \\
\bottomrule
\end{tabular}
\caption{Generators modelling.}
\label{tab:generators_modelling}
\end{table}

\par Concerning the active power balancing:

\begin{itemize}
  \item A generator that does not participate in the voltage regulation cannot participate in the acting power balancing;
  \item A generator with an active power target equal to 0 does not participate in the active power balancing. It can however regulate the voltage;
  \item the active power reference of the others generator define if they participate in the active power balancing.
\end{itemize}

\subsection{HVDC}

Two types of HVDC links are modelled in DynaFlow : LCCs and VSCs.

The parameter \textit{InfiniteReactiveLimits} from the configuration file determines whether the HVDC models have infinite reactive power limits
or PQ diagrams (see section \ref{Dynaflow_Launcher_Configuration_Configuration_File}).

\subsubsection{VSCs}

The conditions and models used are given below.
The information that a HVDC has an AC regulation law is given in the IIDM input file.\\

\begin{table}[ht!]
\center
\begin{tabular}{ c | c | c}
\toprule
\small{\textbf{{Voltage regulation}}}& \small{\textbf{{InfiniteReactiveLimits}}} & \small{\textbf{{Model}}} \\
\midrule
\rowcolor{gray!10}
 \small{At the connection bus} & \small{false}& \small{HvdcPVDiagramPQ} \\
\rowcolor{white}
 \small{At the connection bus} & \small{true}& \small{HvdcPV} \\
\rowcolor{gray!10}
 \small{At a distant bus} & \small{false} & \small{HvdcPQPropDiagramPQ} \\
\rowcolor{white}
 \small{At a distant bus} & \small{true} & \small{HvdcPQProp} \\
\bottomrule
\end{tabular}
\caption{VSCs modelling (not dangling, no AC emulation law)}
\end{table}

\begin{table}[ht!]
\center
\begin{tabular}{ c | c | c}
\toprule
\footnotesize{\textbf{{Voltage regulation}}}& \footnotesize{\textbf{{InfiniteReactiveLimits}}} & \small{\textbf{{Model}}} \\
\midrule
\rowcolor{gray!10}
 \footnotesize{At the connection bus} & \small{false}& \footnotesize{HvdcPVDiagramPQEmulationSet} \\
\rowcolor{white}
 \footnotesize{At the connection bus} & \small{true}& \footnotesize{HvdcPVEmulationSet} \\
\rowcolor{gray!10}
 \footnotesize{At a distant bus} & \small{false} & \footnotesize{HvdcPQPropDiagramPQEmulationSet} \\
\rowcolor{white}
 \footnotesize{At a distant bus} & \small{true} & \footnotesize{HvdcPQPropEmulationSet} \\
\bottomrule
\end{tabular}
\caption{VSCs modelling (not dangling, AC emulation law)}
\end{table}

\begin{table}[ht!]
\center
\begin{tabular}{ c | c | c }
\toprule
\footnotesize{\textbf{{Voltage regulation}}}& \footnotesize{\textbf{{InfiniteReactiveLimits}}} & \small{\textbf{{Model}}} \\
\midrule
\rowcolor{gray!10}
 \footnotesize{At the connection bus} & \small{false}& \footnotesize{HvdcPVDanglingDiagramPQ} \\
\rowcolor{white}
 \footnotesize{At the connection bus} & \small{true}& \footnotesize{HvdcPVDangling} \\
\rowcolor{gray!10}
 \footnotesize{At a distant bus} & \small{false} & \footnotesize{HvdcPQPropDanglingDiagramPQ} \\
\rowcolor{white}
 \footnotesize{At a distant bus} & \small{true} & \footnotesize{HvdcPQPropDangling} \\
\bottomrule
\end{tabular}
\caption{VSCs modelling (dangling)}
\end{table}

\subsubsection{LCCs}

The conditions and models used are given below.

\begin{table}[ht!]
\center
\begin{tabular}{ c | c | c }
\toprule
\small{\textbf{{Dangling}}}& \small{\textbf{{InfiniteReactiveLimits}}} & \small{\textbf{{Model}}} \\
\midrule
\rowcolor{white}
 \small{false} & \small{false}  & \small{HvdcPTanPhi} \\
\rowcolor{gray!10}
 \small{true} & \small{false}& \small{HvdcPTanPhiDangling} \\
\rowcolor{white}
 \small{false} & \small{true}& \small{HvdcPTanPhiDiagramPQ} \\
\rowcolor{gray!10}
 \small{true} & \small{true} & \small{HvdcPTanPhiDanglingDiagramPQ} \\
\bottomrule
\end{tabular}
\caption{LCCs modelling}
\end{table}

\subsection{Static Var Compensators}

The conditions and models used are given below.

\begin{table}[h!]
\center
\begin{tabular}{ c | c | c | c}
\toprule
& & \scriptsize{\textbf{{Custom mode}}} &  \\
\scriptsize{\multirow{-2}{*}{\textbf{{Voltage regulation}}}}& \multirow{-2}{*}{\scriptsize{\textbf{{Control law}}}}& \scriptsize{\textbf{{control law}}} & \multirow{-2}{*}{\scriptsize{\textbf{{Model}}}} \\
\midrule
\rowcolor{white}
 \scriptsize{At the connection bus} & \scriptsize{None}& \scriptsize{false}& \scriptsize{StaticVarCompensatorPV} \\
\rowcolor{gray!10}
 \scriptsize{At the connection bus} & \scriptsize{None}& \scriptsize{true}& \scriptsize{StaticVarCompensatorPVModeHandling} \\
\rowcolor{white}
 \scriptsize{At the connection bus} & \scriptsize{U + Lambda*Q}& \scriptsize{false}& \scriptsize{StaticVarCompensatorPVProp} \\
\rowcolor{gray!10}
 \scriptsize{At the connection bus} & \scriptsize{U + Lambda*Q}& \scriptsize{true}& \scriptsize{StaticVarCompensatorPVPropModeHandling} \\
\rowcolor{white}
 \scriptsize{At a distant bus} & \scriptsize{None}& \scriptsize{false}& \scriptsize{StaticVarCompensatorPVRemote} \\
\rowcolor{gray!10}
 \scriptsize{At a distant bus} & \scriptsize{None}& \scriptsize{true}& \scriptsize{StaticVarCompensatorPVRemoteModeHandling} \\
\rowcolor{white}
 \scriptsize{At a distant bus} & \scriptsize{U + Lambda*Q}& \scriptsize{false}& \scriptsize{StaticVarCompensatorPVPropRemote} \\
\rowcolor{gray!10}
 \scriptsize{At a distant bus} & \scriptsize{U + Lambda*Q}& \scriptsize{true}& \scriptsize{StaticVarCompensatorPVPropRemoteModeHandling} \\
\bottomrule
\end{tabular}
\caption{Static Var Compensators modelling}
\end{table}


\section{Solver}

The solver used is the Simplified Solver (SolverSIM) from \Dynawo.
The Maximum time step value is by default 10s. This value can be modified in the configuration file (see section \ref{Dynaflow_Launcher_Configuration_Configuration_File}).
Notice that the maximum step value should be reduced only when the simulation is including
Special Protection Scheme automatons with a timescale smaller than 10 seconds: this would allow one to properly
take into account the SPS behaviour, avoiding any artificial synchronization effect. When modifying the
solver maximum time step, its value must be included in $ 1.0  < TimeStep \leq 10.0 $ seconds.

The full configuration (with default values) used is the following:

\lstinputlisting[language=XML,title=\Dynawo Simplified Solver configuration]{../resources/syntaxExample/solver.par}

\section{Assembling and Setting files}

The following parameters from the configuration file are used to add additional models and their settings to the system's elements defined in the given .iidm network file (see section \ref{Dynaflow_Launcher_Configuration_Configuration_File}):
\begin{itemize}
  \item The parameter \textit{AssemblingPath} is the path to the assembling file;
  \item The parameter \textit{SettingPath} is the path to the setting file.
\end{itemize}

These two files use a syntax close to the one used for the .dyd and .par files. It's available here etc/xsd/.

\subsection{Assembling file}

The assembling file is a \textbf{.xml} file containing connections between system's elements and models. An example is given below:

\lstinputlisting[language=XML,title=\Dynawo Assembling file example]{../resources/syntaxExample/assembling.xml}

\subsubsection{Use a model}

A dynamicAutomaton statement is required to define a model. The user must also specify an id and the model librairy:

\begin{lstlisting}[language=XML, morekeywords={dynamicAutomaton}]
<dynamicAutomaton id="MODELE_1_VL4" lib="DYNModel1">
  ...
</dynamicAutomaton>
\end{lstlisting}

\subsubsection{Defines sets of connections}

The connection between two different models often needs more than one ``connect'' statement. For example, in order to connect DYNModel1 to the Network we need to connect three variables: shunt\_state, shunt\_isCapacitor and shunt\_isAvailable.
In order not to write the three connections for each DYNModel1 model of the network, we can define a macro connection :
\begin{lstlisting}[language=XML, morekeywords={macroConnection}]
<macroConnection id="ToControlledShunts">
  <connection var1="shunt_state_@INDEX@" var2="@NAME@_state"/>
  <connection var1="shunt_isCapacitor_@INDEX@" var2="@NAME@_isCapacitor"/>
  <connection var1="shunt_isAvailable_@INDEX@" var2="@NAME@_isAvailable"/>
</macroConnection>
\end{lstlisting}

\subsubsection{Connect a model variable to an other model}

In order to connect a variable of a model defined in dynamicAutomaton tags to an other model variable, the user can use a macroConnect. It takes :
\begin{itemize}
  \item A macro connection, to link a current model variable to an other model variable;
  \item An id referring to a system's element (in this cas, the other model will be the Network) or an other model name (see next section \ref{Node_Or_Model_Reference_On_Macro_Connect})
\end{itemize}

\begin{lstlisting}[language=XML, morekeywords={macroConnect}]
<dynamicAutomaton id="MODELE_1_VL4" lib="DYNModel1">
  <macroConnect macroConnection="ToUMeasurement" id="MESURE_MODELE_1_VL4"/>
  <macroConnect macroConnection="ToControlledShunts" id="SHUNTS_MODELE_1_VL4"/>
</dynamicAutomaton>
\end{lstlisting}

\subsubsection{How to reference system's element or an other model in a macroConnect statement ?}
\label{Node_Or_Model_Reference_On_Macro_Connect}

To refer to a bus, a line or a tfo of the system, the user can use a singleAssociation statement. For example, in order to connect MODELE\_1\_VL4 variables to the variables of
the bus with voltage level VLP6, we can define a single association :

\begin{lstlisting}[language=XML, morekeywords={singleAssociation}]
<singleAssociation id="MESURE_MODELE_1_VL4">
  <bus voltageLevel="VLP6" />
</singleAssociation>
\end{lstlisting}

To refer to a shunt of the system, the user can use a multipleAssociation statement :

\begin{lstlisting}[language=XML, morekeywords={multipleAssociation}]
<multipleAssociation id="SHUNTS_MODELE_1_VL4">
  <shunt voltageLevel="VL4"/>
</multipleAssociation>
\end{lstlisting}

To refer to an other model, the user cas use a modelAssociation statement :

\begin{lstlisting}[language=XML, morekeywords={modelAssociation}]
<modelAssociation id="MY_MODEL_ASSOCIATION_ID">
  <model id="MY_MODEL_ID" lib="MY_MODEL_LIB"/>
</modelAssociation>
\end{lstlisting}

\subsection{Setting file}

The setting file is a .xml file containing the needed parameters of the models referenced in the assembling file. The syntax is the same as for .par files.

\end{document}
